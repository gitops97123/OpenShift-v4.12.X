#### Installation

My Lab setup contains two servers. One control plane machine and one node to be used for running containerized workloads.

|Server Type | Server Hostname | Specs|
|------------|-----------------|-------|
|Bastion  |bastion.lab.example.com  | 16GB Ram, 8vcpus|
|Haproxy |haproxy.lab.example.com | 4GB Ram, 2vcpus|
|bootstrap |bootstrap.lab.example.com | 16GB Ram, 8vcpus|
|Master1  |master1.lab.example.com  | 32GB Ram, 16vcpus|
|Master2 |master2.example.com | 32GB Ram, 16vcpus|
|Master3 |master3.example.com | 32GB Ram, 16vcpus|

#### Step 1: Bastion Node 

Operating System Details :

    [root@bastion ~]# cat /etc/redhat-release
    Red Hat Enterprise Linux release 8.6 (Ootpa)

Disk mount details : 

    [root@bastion ~]# lsblk
    NAME          MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
    sda             8:0    0  100G  0 disk
    ├─sda1          8:1    0  500M  0 part /boot/efi
    ├─sda2          8:2    0    1G  0 part /boot
    └─sda3          8:3    0 98.5G  0 part
      └─rhel-root 253:0    0 98.5G  0 lvm  /
    sdb             8:16   0 1020G  0 disk /ocpregistry
    sr0            11:0    1 1024M  0 rom
     
IP Details : 

    [root@bastion ~]# ip address 


subscription-management enablement. : 

    [root@bastion ~]# subscription-management register --auto-attach 
    Registering to: subscription.rhsm.redhat.com:443/subscription
    The system has been registered with ID: a478f3a1-<redacted>-265daf9000fb
    The registered system name is: bastion.lab.example.com
    Ignoring request to auto-attach. It is disabled for org "11009103" because of the content access mode setting.
    
Installation Pre-requisites Packages :-

    [root@bastion ~]# yum install wget curl tree tmux vim git -y
    [root@bastion ~]# yum install nfs-utils -y
    
    [root@bastion ~]# df -h /ocpregistry
    Filesystem      Size  Used Avail Use% Mounted on
    /dev/sdb       1020G  7.2G 1013G   1% /ocpregistry
    
    [root@bastion ~]# echo "/ocpregistry  *(rw,sync)" >> /etc/exports
    
    [root@bastion ~]# exportfs -arv
    exporting *:/ocpregistry
    
    [root@bastion ~]# systemctl enable --now nfs-server
    Created symlink /etc/systemd/system/multi-user.target.wants/nfs-server.service → /usr/lib/systemd/system/nfs-server.service.
    
    [root@bastion ~]# showmount -e
    Export list for bastion.lab.example.com:
    /ocpregistry *
    
    [root@bastion ~]# chown nobody:nobody /ocpregistry/
       
#### Step 2: Download OpenShift Binaries

- https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients/mirror-registry/1.3.6/mirror-registry.tar.gz
- https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.12.36/oc-mirror.tar.gz
- https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.12.36/openshift-client-linux-4.12.36.tar.gz
- https://mirror.openshift.com/pub/openshift-v4/clients/pipeline/latest/tkn-linux-amd64.tar.gz
- https://mirror.openshift.com/pub/openshift-v4/clients/operator-sdk/4.12.36/operator-sdk-v1.22.2-ocp-linux-x86_64.tar.gz
- https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients/helm/3.11.1/helm-linux-amd64
- https://console.redhat.com/openshift/downloads download pullsecret

Placing all binaries to /usr/bin directory. 

    
    [root@bastion ~]# ls
    anaconda-ks.cfg  kubectl                 oc         oc-mirror.tar.gz  openshift-client-linux-4.12.36.tar.gz  tkn-linux-amd64.tar.gz
    helm             mirror-registry.tar.gz  oc-mirror  opc               tkn                                    tkn-pac
    
    [root@bastion ~]# mv helm kubectl oc oc-mirror opc tkn tkn-pac  /usr/bin
    
    [root@bastion ~]# oc version
    Client Version: 4.12.36
    Kustomize Version: v4.5.7
    
    [root@bastion ~]# helm version
    version.BuildInfo{Version:"v3.11.1+6.el8", GitCommit:"66bfc44f827aea6eb8e001150914170ac0d49e2d", GitTreeState:"clean", GoVersion:"go1.18.9"}
    
    [root@bastion ~]# oc-mirror version
    Client Version: version.Info{Major:"", Minor:"", GitVersion:"4.12.0-202309181625.p0.g3ac49d9.assembly.stream-3ac49d9", GitCommit:"3ac49d9bd7c2193ede794e328dfa1142d7735f2e", GitTreeState:"clean", BuildDate:"2023-09-18T18:56:58Z", GoVersion:"go1.19.10 X:strictfipsruntime", Compiler:"gc", Platform:"linux/amd64"}
    
Creating openshift variables : 

    [root@bastion ~]# cat openshift-vars.sh
    export OCP_RELEASE=4.12.36
    export LOCAL_REGISTRY=bastion.lab.example.com:8443
    export LOCAL_REPOSITORY=ocp4/openshift4
    export PRODUCT_REPO=openshift-release-dev
    export RELEASE_NAME=ocp-release
    export ARCHITECTURE=x86_64
    export GODEBUG=x509ignoreCN=0
    export REMOVABLE_MEDIA_PATH=/ocpregistry/ocp-base-images


#### Step 3: Chrony NTP Configuration 

    [root@bastion ~]# yum install chrony -y





#### Step : Quay Registry Configuration

    
    [root@bastion ~]# yum install podman* skopeo -y
    
    [root@bastion ~]# mkdir /ocpregistry/mirror-registry
    
    [root@bastion ~]# tar xf mirror-registry.tar.gz  -C /ocpregistry/mirror-registry
    
    [root@bastion ~]# systemctl enable --now podman.socket podman.service
    Created symlink /etc/systemd/system/sockets.target.wants/podman.socket → /usr/lib/systemd/system/podman.socket.
    Created symlink /etc/systemd/system/default.target.wants/podman.service → /usr/lib/systemd/system/podman.service.
    
    [root@bastion ~]# systemctl status podman.service
    ● podman.service - Podman API Service
       Loaded: loaded (/usr/lib/systemd/system/podman.service; enabled; vendor preset: disabled)
       Active: active (running) since Thu 2023-10-12 18:16:55 IST; 983ms ago
         Docs: man:podman-system-service(1)
     Main PID: 21768 (podman)
        Tasks: 9 (limit: 101036)
       Memory: 19.8M
       CGroup: /system.slice/podman.service
               └─21768 /usr/bin/podman --log-level=info system service
    
    Oct 12 18:16:55 bastion.lab.example.com systemd[1]: Starting Podman API Service...
    Oct 12 18:16:55 bastion.lab.example.com systemd[1]: Started Podman API Service.
    Oct 12 18:16:55 bastion.lab.example.com podman[21768]: time="2023-10-12T18:16:55+05:30" level=info msg="/usr/bin/podman filtering a>
    Oct 12 18:16:55 bastion.lab.example.com podman[21768]: time="2023-10-12T18:16:55+05:30" level=info msg="Not using native diff for o>
    Oct 12 18:16:55 bastion.lab.example.com podman[21768]: time="2023-10-12T18:16:55+05:30" level=info msg="Setting parallel job count >
    Oct 12 18:16:55 bastion.lab.example.com podman[21768]: time="2023-10-12T18:16:55+05:30" level=info msg="Using systemd socket activa>
    Oct 12 18:16:55 bastion.lab.example.com podman[21768]: time="2023-10-12T18:16:55+05:30" level=info msg="API service listening on \">
    lines 1-17/17 (END)
    
    [root@bastion ~]# echo "192.168.31.21 bastion.lab.example.com" >> /etc/hosts
    
    [root@bastion mirror-registry]# ./mirror-registry install --quayHostname bastion.lab.example.com --initUser red$$$ --initPassword $$$$$$$ --quayRoot /ocpregistry/mirror-registry
    
       __   __
      /  \ /  \     ______   _    _     __   __   __
     / /\ / /\ \   /  __  \ | |  | |   /  \  \ \ / /
    / /  / /  \ \  | |  | | | |  | |  / /\ \  \   /
    \ \  \ \  / /  | |__| | | |__| | / ____ \  | |
     \ \/ \ \/ /   \_  ___/  \____/ /_/    \_\ |_|
      \__/ \__/      \ \__
                      \___\ by Red Hat
     Build, Store, and Distribute your Containers
    
    INFO[2023-10-12 18:20:45] Install has begun
    INFO[2023-10-12 18:20:45] Found execution environment at /ocpregistry/mirror-registry/execution-environment.tar
    INFO[2023-10-12 18:20:45] Loading execution environment from execution-environment.tar
    INFO[2023-10-12 18:21:00] Detected an installation to localhost
    INFO[2023-10-12 18:21:00] Did not find SSH key in default location. Attempting to set up SSH keys.
    INFO[2023-10-12 18:21:00] Generating SSH Key
    INFO[2023-10-12 18:21:00] Generated SSH Key at /root/.ssh/quay_installer
    INFO[2023-10-12 18:21:00] Adding key to ~/.ssh/authorized_keys
    INFO[2023-10-12 18:21:00] Successfully set up SSH keys
    INFO[2023-10-12 18:21:00] Attempting to set SELinux rules on /root/.ssh/quay_installer
    INFO[2023-10-12 18:21:00] Found image archive at /ocpregistry/mirror-registry/image-archive.tar
    INFO[2023-10-12 18:21:00] Detected an installation to localhost
    INFO[2023-10-12 18:21:00] Unpacking image archive from /ocpregistry/mirror-registry/image-archive.tar
    INFO[2023-10-12 18:21:03] Loading pause image archive from pause.tar
    INFO[2023-10-12 18:21:14] Loading redis image archive from redis.tar
    INFO[2023-10-12 18:21:26] Loading postgres image archive from postgres.tar
    INFO[2023-10-12 18:21:44] Loading Quay image archive from quay.tar
    INFO[2023-10-12 18:22:35] Attempting to set SELinux rules on image archive
    INFO[2023-10-12 18:22:35] Running install playbook. This may take some time. To see playbook output run the installer with -v (verbose) flag.
    INFO[2023-10-12 18:22:35] Detected an installation to localhost
    
    PLAY [Install Mirror Appliance] ******************************************************************************************************
    
    TASK [Gathering Facts] ***************************************************************************************************************
    ok: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Expand variables] *******************************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/expand-vars.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Expand pg_storage] ******************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Expand quay_root] *******************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Expand quay_storage] ****************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Set expanded variables] *************************************************************************************
    ok: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Install Dependencies] ***************************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/install-deps.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Create user service directory] ******************************************************************************
    ok: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Set SELinux Rules] ******************************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/set-selinux-rules.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Set container_manage_cgroup flag on and keep it persistent across reboots] **********************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Install Quay Pod Service] ***********************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/install-pod-service.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Copy Quay Pod systemd service file] *************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Check if pod pause image is loaded] *************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Pull Infra image] *******************************************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Start Quay Pod service] *************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Autodetect Image Archive] ***********************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/autodetect-image-archive.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Checking for Image Archive] *********************************************************************************
    ok: [root@bastion.lab.example.com -> localhost]
    
    TASK [mirror_appliance : Create install directory for image-archive.tar dest] ********************************************************
    ok: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Copy Images if /runner/image-archive.tar exists] ************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Unpack Images if /runner/image-archive.tar exists] **********************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Loading Redis if redis.tar exists] **************************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Loading Quay if quay.tar exists] ****************************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Loading Postgres if postgres.tar exists] ********************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Install Postgres Service] ***********************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/install-postgres-service.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Create necessary directory for Postgres persistent data] ****************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Set permissions on local storage directory] *****************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Copy Postgres systemd service file] *************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Check if Postgres image is loaded] **************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Pull Postgres image] ****************************************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create Postgres Storage named volume] ***********************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Start Postgres service] *************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Wait for pg_trgm to be installed] ***************************************************************************
    FAILED - RETRYING: [root@bastion.lab.example.com]: Wait for pg_trgm to be installed (20 retries left).
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Install Redis Service] **************************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/install-redis-service.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Copy Redis systemd service file] ****************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Check if Redis image is loaded] *****************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Pull Redis image] *******************************************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Start Redis service] ****************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Install Quay Service] ***************************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/install-quay-service.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Create necessary directory for Quay local storage] **********************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Set permissions on local storage directory] *****************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create necessary directory for Quay config bundle] **********************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Copy Quay config.yaml file] *********************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Check if SSL Cert exists] ***********************************************************************************
    ok: [root@bastion.lab.example.com -> localhost]
    
    TASK [mirror_appliance : Check if SSL Key exists] ************************************************************************************
    ok: [root@bastion.lab.example.com -> localhost]
    
    TASK [mirror_appliance : Create necessary directory for Quay rootCA files] ***********************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create OpenSSL Config] **************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create root CA key] *****************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create root CA pem] *****************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create ssl key] *********************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create CSR] *************************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create self-signed cert] ************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create chain cert] ******************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Replace ssl cert with chain cert] ***************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Copy SSL certificate] ***************************************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Copy SSL key] ***********************************************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Set permissions for key] ************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Set permissions for cert] ***********************************************************************************
    ok: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Copy Quay systemd service file] *****************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Check if Quay image is loaded] ******************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Pull Quay image] ********************************************************************************************
    skipping: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create Quay Storage named volume] ***************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Start Quay service] *****************************************************************************************
    changed: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Wait for Quay] **********************************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/wait-for-quay.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Waiting up to 3 minutes for Quay to become alive at https://bastion.lab.example.com:8443/health/instance] ***
    FAILED - RETRYING: [root@bastion.lab.example.com]: Waiting up to 3 minutes for Quay to become alive at https://bastion.lab.example.com:8443/health/instance (10 retries left).
    ok: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Create init user] *******************************************************************************************
    included: /runner/project/roles/mirror_appliance/tasks/create-init-user.yaml for root@bastion.lab.example.com
    
    TASK [mirror_appliance : Creating init user at endpoint https://bastion.lab.example.com:8443/api/v1/user/initialize] ***************
    ok: [root@bastion.lab.example.com]
    
    TASK [mirror_appliance : Enable lingering for systemd user processes] ****************************************************************
    skipping: [root@bastion.lab.example.com]
    
    PLAY RECAP ***************************************************************************************************************************
    root@bastion.lab.example.com : ok=50   changed=30   unreachable=0    failed=0    skipped=17   rescued=0    ignored=0
    
    INFO[2023-10-12 18:24:50] Quay installed successfully, config data is stored in /ocpregistry/mirror-registry
    INFO[2023-10-12 18:24:50] Quay is available at https://bastion.lab.example.com:8443 with credentials (red$$$, $$$$$$$)
            
    [root@bastion ~]# cp /ocpregistry/mirror-registry/quay-rootCA/rootCA.pem /etc/pki/ca-trust/source/anchors/

    [root@bastion ~]# update-ca-trust

    [root@bastion ~]# podman login https://bastion.lab.example.com:8443
    Username: 
    Password:
    Login Succeeded!

        
            